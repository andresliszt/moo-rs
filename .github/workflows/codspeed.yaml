name: CodSpeed

on:
  push:
    branches:
      - "main"
  pull_request:
  workflow_dispatch:

env:
  DEFAULT_PYTHON: 3.13

jobs:
  benchmarks:
    name: Run benchmarks
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v3
        with:
          python-version: ${{ env.DEFAULT_PYTHON }}
          architecture: 'x64'

      - name: Install rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools

      - name: Set up virtual environment
        run: |
          python -m venv .venv
          . .venv/bin/activate
          pip install --upgrade pip

      - name: Install dependencies (testing extras)
        run: |
          . .venv/bin/activate
          pip install maturin scipy pytest pytest-cov pytest-benchmark pytest-codspeed

      - name: Reinstall built wheel (si aplica)
        run: |
          . .venv/bin/activate
          pip uninstall -y pymoors
          pip install pymoors==0.1.2 --force-reinstall

      - name: Run benchmarks
        run: |
          . .venv/bin/activate
          pytest -s -vvv tests/benchmarks --codspeed
