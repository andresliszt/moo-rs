name: CodSpeed - pymoors

on:
  push:
    branches:
      - "main"
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  DEFAULT_PYTHON: 3.12

jobs:
  pymoors-benchmarks:
    name: Run pymoors benchmarks (Python)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v3
        with:
          python-version: ${{ env.DEFAULT_PYTHON }}

      - name: install rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: install uv
        uses: astral-sh/setup-uv@v6
        with:
          python-version: ${{ env.DEFAULT_PYTHON }}
          # enable-cache: true
          working-directory: pymoors
          activate-environment: true

      - name: Install deps
        working-directory: pymoors
        run: |
          uv sync --group testing

      - name: build pymoors optimized wheel
        id: build
        uses: PyO3/maturin-action@v1
        with:
          manylinux: auto
          args: --release --out dist --interpreter ${{ env.DEFAULT_PYTHON }}
          rust-toolchain: stable
          working-directory: pymoors

      - name: Find built wheel (full path)
        id: find_wheel
        run: |
          echo "ðŸ” Current working directory: $(pwd)"
          echo "ðŸ“‚ Contents of pymoors/dist/:"
          echo "VIRTUAL_ENV: $(VIRTUAL_ENV)"
          ls -lah pymoors/dist

          # Grab the relative path and resolve it to an absolute path
          WHEEL_RELATIVE=$(ls pymoors/dist/*.whl)
          WHEEL_FULL=$(realpath "$WHEEL_RELATIVE")

          echo "ðŸ“¦ Wheel (relative): $WHEEL_RELATIVE"
          echo "ðŸ“¦ Wheel (absolute): $WHEEL_FULL"
          echo "wheel=$WHEEL_FULL" >> $GITHUB_OUTPUT
        shell: bash

      - name: Install built wheel and inspect venv location
        working-directory: pymoors
        run: |
          echo "ðŸ—ï¸ Creating virtual environment with uv venv"
          echo "VENV = $VIRTUAL_ENV"
          echo "ðŸ” Checking for venv and .venv in current directory (pymoors/)"
          for d in venv .venv; do
            if [ -d "$d" ]; then
              echo "âœ… Found pymoors/$d"
            else
              echo "âŒ pymoors/$d not found"
            fi
          done

          echo "ðŸ” Checking for venv and .venv in repository root"
          for d in venv .venv; do
            if [ -d "${GITHUB_WORKSPACE}/$d" ]; then
              echo "âœ… Found $d in repo root"
            else
              echo "âŒ $d not found in repo root"
            fi
          done
          echo "ðŸ“¦ Wheel path from step output: '${{ steps.find_wheel.outputs.wheel }}'"
          echo "ðŸ“¦ Installing the built wheel"
          uv pip install --no-build-isolation --force-reinstall "file://${{ steps.find_wheel.outputs.wheel }}"
          echo "VENV = $VIRTUAL_ENV"

      - name: Run pymoors CodSpeed benchmarks
        uses: CodSpeedHQ/action@v4
        with:
          mode: walltime
          working-directory: pymoors
          token: ${{ secrets.CODSPEED_TOKEN }}
          run: uv run pytest tests/benchmarks --codspeed

  moors-benchmarks:
    name: Run moors benchmarks (Rust)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust (stable)
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable

      - name: Cache Rust compilation artifacts
        uses: Swatinem/rust-cache@v2
        with:
          # Cache the `moors/target` directory to speed up rebuilds
          workspaces: |
            moors -> target

      - name: Install cargo-codspeed
        run: cargo install cargo-codspeed --locked

      - name: Build benchmarks
        working-directory: moors
        run: cargo codspeed build

      - name: Run moors CodSpeed benchmarks
        uses: CodSpeedHQ/action@v4
        with:
          mode: simulation
          working-directory: moors
          token: ${{ secrets.CODSPEED_TOKEN }}
          run: cargo codspeed run
